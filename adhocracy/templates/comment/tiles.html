<%namespace name="components" file="/components.html"/>


<%def name="row(tile, comment)">
    <div class="tile">
        <div class="logo">
            <img src="/img/icons/discuss_24.png" />
        </div>
        <div class="base">
            <h3><a href="${h.entity_url(comment)}">${_("Comment")}</a> 
                ${_("on %s") % h.delegateable.link(comment.topic)|n}</h3>
            <div class="meta">
                ${h.user.link(comment.creator, scope=comment.topic)|n}
                %if len(comment.revisions) == 1:  
                    &middot; ${_("created %s") % h.relative_time(comment.create_time)|n}
                %else:
                    &middot; ${_("edited %s") % h.relative_time(comment.latest.create_time)|n}
                %endif      
            </div>
        </div>
    </div>
</%def>


<%def name="list(tile, comments, topic, variant=None, root=None, recurse=True, ret_url='')">
    <%
    _comments = h.comments_sorted(comments, root=root, variant=variant)
    %>

    %if root is None:
        %if not len(_comments):
            <div class="infobox">
                ${_("No comments were made yet.")}
            </div>
        %endif
    %endif

    %if _comments:
    <ul id="${root is not None and 'c%s_comments' % root.id or ''}"
        class="${root is None and 'comments_list' or 'sub'}">
        %for comment, tile in _comments:
        %if tile.show:
        <li>
            ${full(tile, comment, comments, recurse, ret_url=ret_url)}
        </li>
        %endif
        %endfor
    </ul>
    %endif

    %if root is None:
        %if can.comment.create_on(topic):
        <div class="comment_wrapper">
            <div class="comment">
                ${create_form(None, topic, variant=variant, ret_url=ret_url)}
            </div>
        </div>
        %endif
    %endif
</%def>


<%def name="full(tile, comment, comments, recurse, ret_url='')">
    <%  
    if not tile.show:
        return

    sentiment = {'css': '', 'msg': ''}
    if comment.latest.sentiment == model.Comment.SENT_PRO:
        sentiment = {'css': 'pro', 'msg': _(u'is pro')}
    elif comment.latest.sentiment == model.Comment.SENT_CON:
        sentiment = {'css': 'con', 'msg': _(u'is con')}
    %>

    ## new code:

    <div id="c${comment.id}" class="comment">

        ## comment title (username / pro/con / deleted)
        %if not comment.is_deleted():
        <h5>
            ${h.user.link(comment.creator, scope=comment.topic)|n} 
            <span class="${sentiment['css']}">${sentiment['msg']}</span>
        </h5>
        %else:
        <h5>${_("(deleted)")}</h5>
        %endif

        ## comment text
        %if not comment.is_deleted():
        ${tile.text|n}
        %else:
        <span class="hint">${_("This comment has been deleted.")}</span>
        %endif

        %if can.comment.edit(comment):
        <a class="edit_comment"
           data-comment="${comment.id}"
           href="${h.entity_url(comment, member='edit', 
                                query=dict(ret_url=ret_url))}">
            ${_("edit")}
        </a> 
        %endif

        <div class="comment_actions floatbox">
            <div style="display: none;" class="hover_active">
                <div class="vote_comment">
                    ${tiles.poll.widget(comment.poll)}
                </div>

                ## Number of replies
                %if tile.num_children > 0:
                    %if tile.num_children == 1:
                    <a class="show_comments" href="#">
                        ${_('1 Comment')}
                    </a>
                    %else:
                    <a class="show_comments" href="#">
                        ${_('%s Comments') % tile.num_children}
                    </a>
                    %endif
                %else:
                    <span class="show_comments" href="#">
                        ${_('%s Comments') % tile.num_children}
                    </span>
                %endif

                ## Reply button
                %if can.comment.reply(comment) and recurse:
                <a class="new_comment" data-reply="${comment.id}" href="#">${_('reply')}</a>
                %endif 

            </div>
            <div class="utility">
                <span style="display: none;" class="hover_active">
                    <a href="${h.abuse.for_entity(comment)}">${_("report")}</a>
                    · 
                    <%doc>
                    FIXME: Add when we have implemented permalinks or details overlay dialogs
                    <a href="#">Link</a> · 
                    FIXME: Add when we implemented details dialog
                    <a href="#">Historie</a> · 
                    </%doc>
                </span>

                %if comment.is_deleted():
                ${_("deleted %s") % h.relative_time(comment.delete_time)|n}
                %else:
                  %if not comment.is_edited(): 
                  ${h.relative_time(comment.create_time)|n}
                  %else:
                    %if comment.latest.user == comment.creator:
                    ${_("edited %s") % h.relative_time(comment.latest.create_time)|n}
                    %else:
                    ${_("edited %s by %s") % (h.relative_time(comment.latest.create_time),
                    h.user.link(comment.latest.user, scope=comment.topic))|n}
                    %endif
                  %endif
                %endif

            </div>
        </div>

    </div>


    %if recurse:
    ${list(None, comments, comment.topic, variant=comment.variant, root=comment, recurse=recurse)}
    %endif


    ## /end new code

    <%doc>
    ## old code:

    <div class="comment ${'hidden' if tile.is_low else ''}" id="c${comment.id}">
        <div class="tile 
                        ${'pro' if comment.latest.sentiment == model.Comment.SENT_PRO else ''} 
                      ${'con' if comment.latest.sentiment == model.Comment.SENT_CON else ''} 
                        ${h.poll_position_css(comment.poll)}" id="tile_c${comment.id}">
            <div class="logo rate">
                %if can.comment.rate(comment):
                    <a class="up icon ttip" title="${_("Support this comment")}" href="${h.entity_url(comment.poll, member='rate')}?position=1&${h.url_token()}" 
                        onclick="return adhocracy.rate('#tile_c${comment.id}', ${comment.poll.id}, 1);">
                        &nbsp;
                    </a>
                    <a href="${h.entity_url(comment.poll, member='votes')}" 
                        class="score">${tile.score}</a>
                    <a class="down icon ttip" title="${_("Oppose this comment")}" href="${h.entity_url(comment.poll, member='rate')}?position=-1&${h.url_token()}" 
                        onclick="return adhocracy.rate('#tile_c${comment.id}', ${comment.poll.id}, -1);">
                        &nbsp;
                    </a>
                %else:
                    <a class="up icon inactive">&nbsp;</a>
                    <a href="${h.entity_url(comment.poll, member='votes')}" 
                        class="score">${tile.score}</a>
                    <a class="down icon inactive">&nbsp;</a>
                %endif
            </div>
            
            <div class="base">
            <div class="sentiment">
            %if not comment.is_deleted():
                <b>${h.user.link(comment.creator, scope=comment.topic)|n}</b>
            %endif
            <div class="top_actions comment">               
                %if can.comment.edit(comment):
                    <a class="button edit" 
                       href="${h.entity_url(comment, member='edit', query=dict(ret_url=ret_url))}">${_("edit")}</a> 
                %endif

                %if can.comment.delete(comment):
                    <a class="button delete" href="${h.entity_url(comment, member='ask_delete')}">${_("delete")}</a> 
                %endif

                %if can.comment.reply(comment) and recurse:
                    <a class="button add reply" onClick="return adhocracy.comment_reply(${comment.id})" href="/comment/new?reply=${comment.id}&topic=${comment.topic.id}&wiki=1&ret_url=${ret_url}">${_("reply")}</a>
                %endif 

                <a class="button delete showjs" 
                   onClick="return adhocracy.toggle_comment(${comment.id})">${_("hide")}</a>
            </div>
                
            <div class="title">
                %if comment.is_deleted():
                    ${_("(deleted)")}
                %endif
            </div>
            
            <div class="text hide_edit">
                %if not comment.is_deleted():
                    ${tile.text|n}
                %else:
                    <span class="hint">${_("This comment has been deleted.")}</span>
                %endif
            </div>

            <div class="pre">
                %if comment.is_deleted():
                    ${_("deleted %s") % h.relative_time(comment.delete_time)|n}
                %else:
                    %if not comment.is_edited(): 
                        ${h.relative_time(comment.create_time)|n}
                    %else:
                        %if comment.latest.user == comment.creator:
                            ${_("edited %s") % h.relative_time(comment.latest.create_time)|n}
                        %else:
                            ${_("edited %s by %s") % (h.relative_time(comment.latest.create_time),
                                                           h.user.link(comment.latest.user, scope=comment.topic))|n}
                        %endif  
                    %endif
                    %if comment.wiki:
                        &middot; ${_("editable") if comment.wiki else ''}
                    %endif
                    %if len(comment.revisions) > 1:
                        &middot;
                        <a href="${h.entity_url(comment, member='history')}">${_("history")}</a>
                    %endif
                    &middot;
                    <a href="${h.abuse.for_entity(comment)}">${_("report")}</a>
                    &middot;
                    <a href="${h.entity_url(comment, comment_page=True)}">${_("link")}</a>                    <a href="#" class="thread">Show subthread</a>
                %endif
                <a name="c${comment.id}">&nbsp;</a>
            </div>
            </div>

            <div class="edit_form">
                ${self.edit_form(comment, ret_url=ret_url)}
            </div>
            <div class="reply_form sub ${'base_reply' if reply_here else ''}">
                ${self.create_form(comment, comment.topic, variant=comment.variant, ret_url=ret_url)}
            </div>
            </div>
        </div>
        %if recurse:
            <div class="sub">
                ${list(None, comments, comment.topic, variant=comment.variant, root=comment, recurse=recurse)}
            </div>
        %endif
    </div>
    </%doc>
</%def>

<%def name="edit_form(comment, ret_url='')">

<%

sentiment = comment.latest.sentiment

def klass(sentiment_button):
    value = 'button_small'
    if sentiment_button == sentiment:
        value += ' active'
    return value

klass_pro = klass(1)
klass_neutral = klass(0)
klass_con = klass(-1)
%>
  <div class="comment_form">
    <form name="new_comment" class="comment_form"
          method="POST" action="/comment/${comment.id}">
        ${h.field_token()|n}
        <input type="hidden" name="_method" value="PUT" />
        <input type="hidden" name="ret_url" value="${ret_url}" />
      <div class="subcolumns">
        <div class="c60l">
          <div class="subcl">
            <textarea name="text">${comment.latest.text}</textarea>
            ${components.formatting()}
          </div>
        </div>
        <div class="c40r">
          <div class="subcr comment_settings">
            <div class="input_wrapper comment_status">
              ${_(u'Comment is...')}<br />
              <a class="${klass_pro}" 
                 data-status="1" href="#">${_('Pro')}</a>
              <a class="${klass_neutral}" 
                 data-status="0" 
                 href="#">${_('Neutral')}</a>
              <a class="${klass_con}" 
                 data-status="-1" 
                 href="#">${_('Con')}</a>
              <input type="hidden" name="sentiment" 
                     value="${str(comment.latest.sentiment)}" />
            </div>
            <div class="hr"><hr /></div>
            <div class="input_wrapper submit">
              <input type="submit" value="${_('Save')}" />
              <a class="cancel"
                 href="${h.entity_url(comment.topic)}">${_("cancel")}</a>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

</%def>


<%def name="create_form(parent, topic, wiki=True, arm=False, can_wiki=True, variant=None, ret_url='', format=None)">

<%
if format is None:
    format = ''
else:
    format = ".%s" % format
%>
  <div class="comment_form">
    <h4>${_(u'Add comment')}</h4>
    <form name="new_comment" class="comment_form"
          method="POST" action="/comment${format}">
        ${h.field_token()|n}
        <input type="hidden" name="topic" value="${topic.id}" />
        <input type="hidden" name="ret_url" value="${ret_url}" />
        %if variant:
            <input type="hidden" name="variant" value="${variant}" />
        %endif
        %if parent:
            <input type="hidden" name="reply" value="${parent.id}" />
        %endif
      <div class="subcolumns">
        <div class="c60l">
          <div class="subcl">
            <textarea name="text"></textarea>
            ${components.formatting()}
          </div>
        </div>
        <div class="c40r">
          <div class="subcr comment_settings">
            <div class="input_wrapper comment_status">
              ${_(u'Comment is...')}<br />
              <a class="button_small" data-status="1" href="#">${_('Pro')}</a>
              <a class="button_small" data-status="0" href="#">${_('Neutral')}</a>
              <a class="button_small" data-status="-1" href="#">${_('Con')}</a>
              <input type="hidden" name="sentiment" value="0" />
            </div>
            <div class="hr"><hr /></div>
            <div class="input_wrapper">
              <label for="wiki">
                  <input id="editable" name="wiki" type="checkbox" /> 
                  ${_("Allow others to edit this comment.")}
              </label>
            </div>
            <div class="hr"><hr /></div>
            <div class="input_wrapper submit">
              <input type="submit" value="${_('Save')}" />
              <a class="cancel" 
                 href="${'/d/%s' % parent.topic.id if parent else request.params.get('topic')}">${_("cancel")}</a>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

</%def>


<%def name="header(tile, comment, active)">
    <div class="top_actions title">
        %if can.comment.edit(comment):
            <a class="button edit" onClick="return adhocracy.comment_edit(${comment.id})" 
                href="${h.entity_url(comment, member='edit')}">${_("edit")}</a> 
        %endif
                        
        %if can.comment.delete(comment):
            <a class="button delete" 
                href="${h.entity_url(comment, member='ask_delete')}">${_("delete")}</a> 
        %endif
        
        ${components.watch(comment)}
    </div>

    <h1 class="page_title"><img src="/img/icons/discuss_24.png" class="cd" /> 
        ${_("Discussion on %s") % h.delegateable.link(comment.topic, icon_size=24)|n}</h1>
    
    <div class="panel ${active}">
        <ul class="menu">
            <li><a href="${h.entity_url(comment)}">${_("Context")}</a></li>
            <li><a href="${h.entity_url(comment, comment_page=True)}" 
                class="discussion">${_("Comment")}</a></li> 
            <li><a href="${h.entity_url(comment, member='history')}" 
                class="history">${_("History")} (${len(comment.revisions)})</a></li>
            <li><a href="${h.entity_url(comment.poll, member='votes')}" 
                class="votes">${_("Votes")} (${len(comment.poll.tally)})</a></li>
        </ul>
    </div>
</%def>

<%def name="form(display=False)">
  <!-- new comment form -->
  <div id="comment_form_template" ${'style="display: none;' if display == False else ''}">
    <h4>${_(u'Add comment')}</h4>
    <form name="new_comment" class="comment_form" 
          method="POST" action="/comment">

        <input type="hidden" name="topic" value="${topic.id}" />
        <input type="hidden" name="ret_url" value="${ret_url}" />
        %if variant:
            <input type="hidden" name="variant" value="${variant}" />
        %endif
        %if parent:
            <input type="hidden" name="reply" value="${parent.id}" />
        %endif

      <div class="subcolumns">
        <div class="c60l">
          <div class="subcl">
            <textarea></textarea>
          </div>
        </div>
        <div class="c40r">
          <div class="subcr comment_settings">
            <div class="input_wrapper comment_status">
              ${_(u'Comment is...')}<br />
              <a class="button_small" status="pro" href="#">${_('Pro')}</a>
              <a class="button_small" status="neutral" href="#">${_('Neutral')}</a>
              <a class="button_small" status="contra" href="#">${_('Con')}</a>
              <input type="hidden" name="comment_status" value="pro" />
            </div>
            <div class="hr"><hr /></div>
            <div class="input_wrapper">
              <label for="editable"><input id="editable" name="editable" type="checkbox" />Andere dürfen diese Antwort bearbeiten.</label>
            </div>
            <div class="hr"><hr /></div>
            <div class="input_wrapper submit">
              <input type="submit" value="Kommentieren" /><a class="cancel" href="#">Abrechen</a>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

</%def>
