<%inherit file="/template.html" />
<%namespace name="components" file="/components.html"/>
<%namespace name="comment_tiles" file="/comment/tiles.html"/>
<%namespace name="state" file="/poll/state.html"/>

<%def name="title()">${c.proposal.title}</%def>

<%def name="breadcrumbs()">${h.proposal.breadcrumbs(c.proposal)|n}</%def>


<%block name="main_content">

    %if not c.proposal.is_adopt_polling() and c.proposal.rate_poll:
      %if can.proposal.rate(c.proposal):
      ${tiles.poll.widget(c.proposal.rate_poll, cls='big')}
      %endif
    %endif

            <section>
              <article>
                <h2>
                    ${h.delegateable.link(c.proposal, icon_size=24, link=False)|n}
                </h2>
                <div class="hr"><hr /></div>
                
                <div class="utility">
<%doc>FIXME: translate:</%doc><h4>Ziele und Beschreibung des Vorschlages</h4
                    %if can.proposal.edit(c.proposal):
                    <a href="${h.entity_url(c.proposal, member='edit')}">
                        ${_("edit")}
                    </a>
                    %endif
                </div>
                
                ${tiles.page.inline(c.proposal.description, 
                        hide_discussion=c.instance.use_norms and len(c.proposal.selections))}
    
                
                ## FIXME: Translate; Really "Reaktions", not "Comments"?
                <div class="meta">
                    <a href="#reactions">
                        ${c.proposal.description.comment_count()} ${_("Comments")}
                    </a>
                    %if c.show_selections:
                    &middot; 
                    <a href="#proposals">
                        ${len(c.num_selections)}
                        ${_("Proposed Implementations")}
                    </a>
                    %endif
                    &middot; 
                    <a href="${h.abuse.for_entity(c.proposal)}">
                        ${_("report")}
                    </a>
                    &middot;
                    <a href="${c.history_url}"
                       rel="#overlay-ajax">History</a>
                </div>
              </article>
              <br />

              <div id="main_comments">
                  <h3 id="reactions">${_(u'Comments')}</h3>
                  ## comments are attached to the description which is a
                  ## :class:`adhocracy.model.Page`
                  ## proposal descriptions have no other variant than head.
                  ${tiles.comment.list(c.proposal.description, 
                                       variant=c.proposal.description.head.variant)}
            </div>
            </section>
            

            %if c.show_selections:
            <section>
              <h3 id="proposals">${_("Proposed Implementations")}</h3>
              <div class="hr"><hr /></div>
              <ul class="papers_list">
                  %for selection in c.sorted_selections: 
                  ${tiles.selection.row(selection)}
                  %endfor
              </ul> 
            </section>
            %endif

</%block>


<%block name="sidebar">

${components.watch(c.proposal, what="Proposal")}

<h3>${_('Informations')}</h3>
<summary>

    ${components.shortlink(c.proposal)}

    <h6>${_('Last Activity')}</h6>
    <p><time>
        ${h.relative_time(
        c.proposal.find_latest_comment_time())|n}
    </time></p>

    <% tally = c.proposal.rate_poll.tally %>
    <h6>${_('Votes')}</h6>
    <p>
        Insgesamt 
        <a href="#">${tally.score} Stimmen</a>, 
        davon ${tally.num_for} Unterstützungen, 
        ${tally.num_against} Ablehnungen.
    </p>

    <h6>${_('Milestones')}</h6>
    <% milestone = c.proposal.milestone %>
    <p>
        %if milestone:
        %if milestone.is_deleted():
        ${_("This proposal relates to the deleted milestone %s."
        ) % h.milestone.link(milestone)|n}
        %else:
        ${_("This proposal relates to the milestone %s."
        ) % h.milestone.link(milestone)|n}
        %endif
        %else:
        ${_("This proposal is not related to a milestone")}
        %endif
    </p>
    <h6>${_('Created')}</h6>
    ## FIXME: ensure caching of history count (make it a tile?)
    <p>
<%
created_msg = _("by %s on %s, %s changes since then.") % (
    h.user.link(c.proposal.creator), 
    h.format_date(c.proposal.create_time),
    len(c.proposal.description.variant_history(model.Text.HEAD)))
%>
    </p>
    ${created_msg|n}
    ${tiles.tag.sidebar(c.proposal)}
    
    ## FIXME: Reimplement Tagging
    ## <div class="only-js" id="add-tag">
    ##     <a href="#">Schlagwort hinzufügen</a>
    ## </div>
</summary>


</%block>
